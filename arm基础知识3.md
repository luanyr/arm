

#### ARM异常

异常是理解CPU运转最重要的一个知识点，几乎每种处理器都支持特定异常处理，中断是异常中的一种。有时候我们衡量一个操作系统的时候实时性就是看os最短响应中断时间以及单位时间内响应中断次数

#### 异常源

| 异常源   | 描述                                                         |
| :------- | :----------------------------------------------------------- |
| Reset    | 上电时执行                                                   |
| Undef    | 当流水线中的某个非法指令到达执行状态时执行                   |
| SWI      | 当一个软中断指令被执行完的时候执行                           |
| Prefetch | 当一个指令被从内存中预取时，由于某种原因而失败，如果它能到达执行状态这个异常才会产生 |
| Data     | 如果一个预取指令试图存取一个非法的内存单元，这时异常产生     |
| IRQ      | 通常的中断                                                   |
| FIQ      | 快速中断                                                     |

##### 异常优先级

RESET->DATA->FIQ->IRQ->PREFETCH->UNDEF/SWI

##### **FIQ 比 IRQ快的原因**

1. fiq 比 irq 的优先级高
2. FIQ 向量位于向量表的最末端，异常处理不需要跳转
3. FIQ 比 IRQ 多5个私有的寄存器（r8-r12），在中断操作时，压栈出栈操作的少。

#### 异常发生的硬件操作

1.保存执行状态：将CPSR复制到SPSR;异常处理结束时，SPSR的值返回CPSR恢复执行状态；

2.模式切换：CPSR模式位切换到相应的异常状态；

​						处理器进入ARM执行模式；

​						禁止所有中断；

3.保存返回地址：将下一条执行指令地址保存到LR中；

4.跳入异常向量表：强制设置PC为相应的向量表的地址

#### 异常向量表

异常向量表是一段特定的内存空间地址，每种ARM异常对应一个字长空间，正好是一条32位指令长度，当异常发生时，CPU强制将PC值设置为异常对应的固定内存地址。



​						![图片](https://mmbiz.qpic.cn/mmbiz_png/icRxcMBeJfcic9vhx82AWl2cFZZFS5LeP6ND5iaZ4WNO1sryMPrYfr4LUGGDCT3j70ich5nfsA6YhbMnADicrOPI9OQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

跳入异常向量表是异常发生时，硬件自动完成的，剩下的异常处理程序由程序员完成。

##### 保存执行现场

异常处理程序最开始需要保存被打断程序的执行现场，程序执行现场就是保存操作寄存器中的数据，通过下面的栈操作保存现场：

STMFD SP_excep!, {R0 – R12, LR_excep}

STMFD=store multi full descending 多次入栈满栈递减

在跳转到异常处理程序入口时，已经切换到对应异常模式下，所以这里的SP是异常模式下的SP_excep，所以被打断程序程序现场的数据是保存在异常模式下的栈中，保存LR是为了完成异常处理后，通过MOV PC, LR返回用户程序继续执行。

#### 异常处理返回

异常处理完成后，返回被打断的程序继续执行，具体操作：

1. 恢复被打断程序运行时的寄存器数据
2. 恢复程序运行时的CPSR
3. 通过入栈的LR，返回被打断程序继续执行

##### 异常返回地址

CPU由于采用流水线技术，所以当前执行的指令为PC-8（ARM指令集每条指令4字节），那么下条执行的指令地址为PC-4。当异常发生时，CPU将PC-4的地址放入LR寄存器。

##### 模式恢复

LDMFD SP_excp!, {r0-r12, pc}^

原本入栈的是R0-R12,LR现在出栈恢复到寄存器R0-R12,PC，^符号表示恢复SPSR到CPSR。

#### 异常与模式关系

1. reset异常进入SVC模式
2. fiq快速中断请求异常进入快中断模式，支持高速数传输及通道处理（FIQ异常响应时进入此模式）
3. irq中断请求异常进入中断模式，用于通用中断处理，（IRQ异常响应时进入此模式）
4. prefetch预取指中止，数据中止异常进入中止模式，用于支持虚拟内存和/或存储器保护
5. undef未定义指令异常进入未定义模式，支持硬件协处理器的软件仿真（未定义指令异常响应时进入此模式）
6. swi软件中断，复位异常进入管理模式，操作系统保护代码（系统复位和软件中断响应时进入此模式）

#### IRQ中断

中断处理流程

![图片](https://mmbiz.qpic.cn/mmbiz_png/icRxcMBeJfcic9vhx82AWl2cFZZFS5LeP6dMx7v5O9aURMicavNicmXV36lfKPU9D1M7NzXRfagqRVs5UurksojO1w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



